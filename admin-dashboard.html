<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h2>Admin Dashboard</h2>
  <button onclick="logout()">Logout</button>

  <h3>Add Product</h3>
  <input type="text" id="name" placeholder="Product Name">
  <input type="number" id="price" placeholder="Price">
  <input type="text" id="category" placeholder="Category (Kurti/Saree/Dress)">
  <input type="file" id="image_file">
  <input type="number" id="discount" placeholder="Discount %">
  <button onclick="addProduct()">Add Product</button>

  <h3>Products</h3>
  <div id="products-list"></div>

  <script type="module">
    import { supabase } from './supabase.js'

    async function fetchProducts() {
      const { data, error } = await supabase.from('products').select('*').order('created_at', { ascending: false })
      const container = document.getElementById('products-list')
      container.innerHTML = ''
      if (error) return console.error(error.message)

      data.forEach(p => {
        const div = document.createElement('div')
        div.innerHTML = `
          <strong>${p.name}</strong> - â‚¹${p.price} - ${p.category} - ${p.discount || 0}%
          <br>
          <img src="${p.image_url}" width="100" style="margin:5px 0;">
          <br>
          <button onclick="editProduct('${p.id}')">Edit</button>
          <button onclick="deleteProduct('${p.id}')">Delete</button>
        `
        container.appendChild(div)
      })
    }

    async function addProduct() {
      const name = document.getElementById('name').value
      const price = document.getElementById('price').value
      const category = document.getElementById('category').value
      const discount = document.getElementById('discount').value
      const fileInput = document.getElementById('image_file')
      const file = fileInput.files[0]

      if (!name || !price || !category || !file) return alert('Please fill all fields and select an image!')

      // Upload image to Supabase Storage
      const fileName = `${Date.now()}_${file.name}`
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('product-images')
        .upload(fileName, file)

      if (uploadError) return alert(uploadError.message)

      const { publicUrl } = supabase.storage.from('product-images').getPublicUrl(fileName)

      const { error } = await supabase.from('products').insert([{ name, price, category, discount, image_url: publicUrl }])
      if (error) alert(error.message)
      else {
        fetchProducts()
        document.getElementById('name').value = ''
        document.getElementById('price').value = ''
        document.getElementById('category').value = ''
        document.getElementById('discount').value = ''
        fileInput.value = ''
      }
    }

    async function editProduct(id) {
      const newName = prompt('Enter new name')
      if (!newName) return
      const { error } = await supabase.from('products').update({ name: newName }).eq('id', id)
      if (error) alert(error.message)
      else fetchProducts()
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure?')) return
      const { error } = await supabase.from('products').delete().eq('id', id)
      if (error) alert(error.message)
      else fetchProducts()
    }

    async function logout() {
      await supabase.auth.signOut()
      window.location.href = 'admin.html'
    }

    fetchProducts()
  </script>
</body>
</html>
